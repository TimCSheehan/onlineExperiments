<!-- Turn from response angle to the answ = mod((respAng-wrot),360) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://psyc241.ucsd.edu/S_Tim/UMI_Task_v7_centerCue_fix/support/vismemCC_orientation.js"></script>
<!-- <script src="support/vismemCC_orientation.js"></script> -->
<script src="https://timbrady.org/turk/TimTurkTools.js"></script>
<link rel="stylesheet" type="text/css" href="https://psyc241.ucsd.edu/S_Tim/UMI_Task_v7_centerCue_fix/support/contReport_v5.css">
<link rel="stylesheet" type="text/css" href="https://psyc241.ucsd.edu/S_Tim/UMI_Task_v7_centerCue_fix/support/showTrials_v5.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.6.0/papaparse.min.js"></script>  <!-- to parse csv -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/seedrandom/2.3.10/seedrandom.min.js"></script>

<!-- <link rel="stylesheet" type="text/css" href="support/contReport_v5.css">
<link rel="stylesheet" type="text/css" href="support/showTrials_v5.css"> -->
<!-- <link rel="stylesheet" type="text/css" href="https://psyc241.ucsd.edu/S_Tim/UMI_Task_v7_centerCue/support/experiment_v5.css"> -->


<style type="text/css">.trialDiv {

      /* border: 2px solid gray;*/
      border: 0px;
      padding: auto;
      width: auto;
      position: relative;
      top: 20px;
      left: 50%;
      /* bring your own prefixes */
      transform: translate(-50%, -50%);
      text-align: center;
      display: none;
    }

    body {
	  
      font-family: Arial, Helvetica;
      background-color: #808080;
      font-size: 12pt;
    }

    #submitButton {
      display: none;
    }

    #instructions {
      width: 60%;;
      margin: 0 auto;
      text-align: center;
      margin-top: 100px;
    }

    #startExperiment {
      color: rgb(200,200,200);
      text-decoration: none;
    }

    #startExperiment:hover{
      color: white;
    }

    #startExperimentButton {
      width: 200px;
      text-align: center;
      border: 4px outset gray;
      background: gray;
      padding: 5px;
      margin: 0 auto;
    }

    #meter{
    width: 10cm;
    height: 10cm;
    }

    .instr {
      display: none;
    }
    #done {
    display: none;
    }



</style>




<div class="taskDiv" id="done">Saving data...</div>

<p><input id="submitButton" name="submitButton" style="display: none" type="submit" value="Submit" /></p>

<!-- <div id="lookDown" style="visibility: hidden">
    <p> 
    <br> <font color="white">Scroll Down for instructions</font> </p>
</div> -->

<div id="instructions">
<h2>This task is a orientation memory task.<br />
Please only do 1 HIT of this task, do not repeat it.</h2>

<p>This HIT will take approximately 10 minutes. You will have to remember an orientated grating and decide whether a second graiting is rotated clockwise or counter-clockwise to the first. Please do not participate if you do not have normal or corrected-to-normal vision (wearing glasses or contacts is fine). During the HIT, you&#39;ll perform 65 trials of the same task; each trial lasts ~7 seconds + how long you take to respond.</p>

<p> ****** You will first see an example trial. Note that you may need to scroll down to see instructions during the first phase. ****** </p>

<p>&nbsp;</p>

<p><b>To proceed, please go fullscreen. Your screen needs to be > than 800 pixels and your browser window > 80% of your screen width to proceed. </b><br />
<p><b>NOTE: This HIT is only tested on the Google Chrome Browser and may be incompatable with others. </b><br />

Press <b>F11</b> to go full screen on a Windows PC</p>

<p style="font:5px">Clicking on the button will indicate that you have read this consent document and agree to participate.</p>

<div id="startExperimentButton"><a href="#" id="startExperiment">Start Experiment</a></div>

<p>&nbsp;</p>

<div align="justify" id="consent" style="height:120px; border:1px solid #ccc;font:12px Arial, Helvetica; overflow:auto">
<p align="center"><b>UNIVERSITY OF CALIFORNIA, SAN DIEGO<br />
CONSENT TO ACT AS A RESEARCH SUBJECT</b></p>

<p><br />
Timothy Brady, Ph.D., is conducting a research study to find out more about attention, memory and vision. You have been asked to participate because you are a healthy young adult. There will be approximately 1600 participants in this study this year. The expected duration of the study is 5 years, though your participation will last only between 3 minutes and 45 minutes, with the exact expected timing listed in the HIT description.</p>

<p><br />
<b>PROCEDURES.</b> If you agree to participate in this study by accepting this HIT and continuing in the task, the following will happen to you:<br />
&emsp; 1. You will be shown displays of letters, words, or pictures, right here in your web browser.<br />
&emsp; 2. You will try to perceive and remember these stimuli, and respond by pressing keys or moving and clicking the mouse in a manner that we will describe to you.</p>

<p><br />
<b>RISKS.</b> You will be required only to continue to interact with your web browser and make responses for a short duration. Thus, no potential risks or discomforts are anticipated except for the possibility that some tasks may be slightly boring. However, there may be risks that are currently unforeseeable.</p>

<p><br />
<b>PAYMENT/REMUNERATION.</b> In consideration of your time, you will receive payment at the rate described through the Amazon Mechanical Turk system. Compensation will range from $0.60 (for a 3 min task) up to as much as $8 (for a task that takes 45 min), with rates between $8/hr and $12/hr. The exact payment rate for this HIT is provided in the HIT description.</p>

<p><br />
<b>RIGHTS.</b> You may call the UCSD Human Research Protection Program at 858-657-5100 to ask about your rights as a research subject or to report research-related problems.</p>

<p><br />
<b>BENEFITS.</b> There will be no direct benefit to you from these procedures. However, the investigator may learn more about basic questions pertaining to attention, memory and vision. This knowledge may have benefits to society in fields ranging from improving education to visual design, but these benefits will be indirect.</p>

<p><br />
<b>EXPLANATION.</b> The researcher has explained this study to you and answered your questions. If you have questions about the research or research-related problems, including any adverse events, you may reach Dr. Timothy Brady at timbrady@ucsd.edu or 858-822-4530.</p>

<p><br />
<b>VOLUNTARY NATURE OF PARTICIPATION.</b> Participation in research is entirely voluntary. You may refuse to participate or withdraw at any time without penalty. The alternative to participation is to choose not to participate.</p>

<p><br />
<b>CONFIDENTIALITY.</b> Research records will be kept confidential to the extent allowed by law. As with all research, there is also the possibility of loss of confidentiality. Information from participants such as yourself will be identified by a subject number, which is not associated with your identity, by the researchers, to minimize the potential loss of confidentiality.</p>

<p><br />
By clicking &ldquo;I agree&rdquo;, you are indicating that you are at least 18 years old, have read this consent form and agree to participate in this research study. Please print a copy of this page for your records.</p>

<p>&nbsp;</p>
</div>
</div>

<div align="center"><canvas height="500" id="myCanvas" style="cursor:default;border:none;outline-width:2px;outline-color:#000000;background:#808080;" width="1200"> </canvas>

<p id="instr">&nbsp;</p>
</div>

<div class="trialDiv" id="frame1">
<p><br />
Please keep your eyes at in the middle (where the <b>+</b> is).<br />
A target will appear around this fixation point. <br />
<br />
Please press <b>space bar</b> to see what this the stimuli presentation will look like.</p>
</div>

<div class="trialDiv" id="frame21">
<p><br />
One target will flash in the middle of the screen. You will have to remember the <b>orientation</b> of this object as precisely as possible.<br />
A noise patch will appear after the object is presented.<br />
<br />
Please press <b>space bar</b> to see what the noise patches look like.</p>
</div>

<div class="trialDiv" id="frame22">
<p><br />
The noise patches ensure an after-image does not remain on your screen.<br/>
After a long delay, a second orientation will flash on the screen.  <br/>
<br/><b>Your job is to judge whether the second object is rotated clockwise (CW) or counter-clockwise (CCW) from the first object. </b> <br/> <br/>
You will press <b>Q</b> for CCW and <b>P</b> for CW

<br />Please press <b>space bar</b> to try an example trial.<br/></p>
</div>


<div class="trialDiv" id="frame4">
<p><br/>
Just like that! <br/> On most trials the change will be quite small so pay close attention to the first item. <br/>
<br/> Please answer as <i>quickly</i> as you decide your answer. After each trial, press space to advance to the next item. 
<br />Please press <b>space bar</b> to advance to the first trial.</p>
</div>


<p id="debug">&nbsp;</p>

<div id='leftright'; class='trialDiv'>
    <p> 
    <br> Press <b>q</b> for CCW, <b>p</b> for CW.</p>
</div>

<div id='ITI_Space'; class='trialDiv'>
    <p> 
    <br> Press <b>[SPACE]</b> to advance to the next trial.</p>
</div>


<form action="examplePause.php" id="record" method="post" name="nextpage"><input id="targ" name="targ" type="hidden" value="[0,0,0,0,0,0,0,0,0,0,0,0]" /> <input id="resp" name="resp" type="hidden" value="[0,0,0,0,0,0,0,0,0,0,0,0]" /> <input id="targAng" name="targAng" type="hidden" value="[0,0,0,0,0,0,0,0,0,0,0,0]" /> <input id="respAng" name="respAng" type="hidden" value="[0,0,0,0,0,0,0,0,0,0,0,0]" /> <input id="rt" name="rt" type="hidden" value="0" /></form>

<script> 

        // Settings
        var task='allTrain';
        var c1=document.getElementById("myCanvas");
        var ctx1=c1.getContext("2d");    
        var centerX=c1.width/2;
        var centerY=c1.height/2; 
        var LRpos = centerX*0.75/2;  
        // var LRpos = 0;  
        var picsiz = Math.ceil(LRpos*1.5)*1.5*1.0;
        var LRpos = 0;  
        var width=c1.width;
        var height=c1.height;
        var objSize=35;
        var objDist=100; 
        var wheelRad=objSize+objDist+60;
        var nubX=null;
        var nubY=null;
        var numDots=3;
        var colRot= 0;
        var circRot= 5.5;

        var is_practice = true;
       

        var srcitem00 = "https://psyc241.ucsd.edu/S_Tim/CD_Task_v1/support/gaborT0.png";
        var srcitem01 = "https://psyc241.ucsd.edu/S_Tim/CD_Task_v1/support/gaborT1.png";
        var srcitem20 = "https://psyc241.ucsd.edu/S_Tim/CD_Task_v1/support/gaborN0.png";
        var srcitem21 = "https://psyc241.ucsd.edu/S_Tim/CD_Task_v1/support/gaborN1.png";
        var root_seq  = "https://psyc241.ucsd.edu/S_Tim/CD_Task_v1/support/csv_stim_v1/";

        var prestim     = 0;
        var stimdur     = 500;
        var noisedur    = 400; // 200
        var noisedur2   = 200; // 200
        var interstim   = 3000;  // 3500
        var retrocue    = 0;
        var delay_mid   = 0; 
        var postcue     = 0;
        // var delay_end   = 500;
        var feedbacktime = 0;
        var iti         = 250;
        var CCWKey = 113; // Q- 81, q- 113
        var CWKey  = 112; // P- 80, p- 112 

        var nTrials // need to initialize here to be global
        var trialStruct = [];
        
        var alltstord = 0;
        var respCWs =[];
        var rt=[];
        var moveLast=0;
        var isTest=false;

        var isTestkey=false;
        var angles_start = "${0}";
        var angles_linear =  angles_start.split(' ');
        var angles = [];
        var GaborTrials = [];
        var n_loop = angles_linear.length/2;

        for (irep=0; irep<n_loop; irep++){
          angles.push([angles_linear[irep*2], angles_linear[irep*2+1]]);
          }

        // make_gabor_trials(angles)

        // lets get a random integer, load said data, and push into gabor trials sequence
        // Math.seedrandom(); // seed RNG. based on current browser settings/entropy

        // var seq_want=Math.floor(Math.random()*59.99);
        // if (seq_want<10){
        //   var seq_grab = root_seq + "00" + seq_want + ".csv";
        // }
        // else {
        //   var seq_grab = root_seq + "0" + seq_want + ".csv";
        // }

        // Papa.parse(seq_grab,{download: true,
        //   complete: function(results){angles_load = results.data;
        //     make_gabor_trials(angles_load)}
        // });


        function make_gabor_trials(angs){
          for (var irep=0; irep<angs.length; irep++){
              var ang = angs[irep];
              var noise = ((Math.random()*180)-90,(Math.random()*180)-90);

              GaborTrials.push({'orients': ang,
                  'iti': iti,
                  'noise': noise});} 
          nTrials = GaborTrials.length;}
        make_gabor_trials(angles)

        var selColor=[];var selAng=[];
        for (var item=0;item<numDots;item++){selColor[item]='#FFFFFF';selAng[item]=null};


        function wrap(v,bound) {
          w = Array(v.length)
          for (var i=0; i<v.length; i++) {

            
            if (v[i]>=(-bound)) { w[i] = ((v[i]+bound)%(bound*2) )-bound;}
            if (v[i]<(-bound)) { w[i] = ((v[i]+bound)%(bound*2) + bound*2)-bound;}

          }
          return w;
        } 


        function shuffle(array) {
          var currentIndex = array.length, temporaryValue, randomIndex;

          // While there remain elements to shuffle...
          while (0 !== currentIndex) {

            // Pick a remaining element...
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex -= 1;

            // And swap it with the current element.
            temporaryValue = array[currentIndex];
            array[currentIndex] = array[randomIndex];
            array[randomIndex] = temporaryValue;
          }

          return array;
        }
        
       

        var rt=[];
        var moveLast=0;
        
        
        var isTest=false;
        var isTrain = false;
        var currProbe=-1;
        
        
        function makeCrosshair(){
            // Draw rectangles
                makeRectangle('cross1',centerX,centerY,4,12,false,'#000000','#000000');
                makeRectangle('cross2',centerX,centerY,12,4,false,'#000000','#000000');
        }
        function makeCrosshairWhite(){
    // Draw rectangles
        makeRectangle('cross1',centerX,centerY,4,12,false,'#ffffff','#ffffff');
        makeRectangle('cross2',centerX,centerY,12,4,false,'#ffffff','#ffffff');
        }

        function makeColorWheelBW(){
            makeCircle('circout',centerX,centerY,wheelRad+objSize*0.05,false,0,'#000000','#808080')
            makeCircle('circin',centerX,centerY,wheelRad,false,0,'#808080','#808080')
        }
        function makeColorNub(){
            // Draw nub on color wheel using 
            makeCircle('colorWheelNub',centerX+nubX,centerY+nubY,5,false,0,'#d3d3d3','#d3d3d3');
            makeCircle('colorWheelNub',centerX-nubX,centerY-nubY,5,false,0,'#d3d3d3','#d3d3d3');
        }
        
        function makeProbe(tothisside){
            makeTriangle('probe',centerX,centerY,20,30,'#000000','#000000',pointto[tothisside]);
            // makeTriangle('probe',centerX,centerY,20,20,'#ffffff','#ffffff',tothisside);
        }

        function makeArrowCue(tothisside){
          if (tothisside!=2){
            makeTriangle('cue',centerX,centerY,20,30,'#ffffff','#ffffff',pointto[tothisside]);
          }
          else {
            makeTriangle('cue0',centerX,centerY,20,20,'#ffffff','#ffffff',pointto[0]); // just overlapping triagles?
            makeTriangle('cue1',centerX,centerY,20,20,'#ffffff','#ffffff',pointto[1]);
          }
        }

        function makeNumberCue(text){
            // makeTriangle('cue',centerX,centerY,20,20,'#000000','#000000',tothisside);
            makeText('arrowcue',centerX-12,centerY+22,text,'Black','50px Arial');
        }

        var st=null;
        function startTime(){
            var d = new Date();
            st=d.getTime();
        }

        function endTime(){
            
            var d = new Date();
            timeDif=d.getTime()-st;
            return timeDif;
        }


        var curTrial = 0;

        function trialIsOver() {

            if (!is_practice){
             $(document).on("keypress.trialWait")
            
            //givefeedback 
            erase(ctx1);
            clear();

              var curtrialStruct = GaborTrials[curTrial];
              
              curtrialStruct.respCW  = respCWs[curTrial];
              curtrialStruct.rt = rt[curTrial];
              curtrialStruct.realtime = realtime;

              trialStruct.push(curtrialStruct);

              curTrial = curTrial+1 ; 

              if (curTrial >= nTrials){
                  Done();
                  // $('#submitButton'.show());
              } else {
                  $('#ITI_Space').show();
                  $(document).on("keypress.trialWait", function PressedKey(evt) {
                    $('#ITI_Space').hide();
                    evt.preventDefault();
                    showTrial(curTrial);
                    startTrialTime = new Date();
                });
              }


            // },feedbacktime)
          }
          else{
            console.log("Going back to practice...")
            showPractice_f4();}
        }


        function showTrial(whichtrial){
        	// var pointer = [1,2];
             $(document).off("keypress.trialWait")
             isTest=false;
             isTestKey=true;

             p = [];

             p.oL = GaborTrials[whichtrial].orients[0];
             p.oR = GaborTrials[whichtrial].orients[1];
             p.noL = GaborTrials[whichtrial].noise[0];
             p.noR = GaborTrials[whichtrial].noise[1];

             // p.probeDir = [1,2][Math.abs(!GaborTrials[whichtrial].probeLeft)]; 
             // p.cueDir = GaborTrials[whichtrial].cueDirec;
            
             // p.targetang = GaborTrials[whichtrial].orients[0];
             p.whichtrial = whichtrial;
             realtime = [];
             prestim = GaborTrials[whichtrial].iti;
             curprobe = p.probeDir;
             // console.log(curprobe)

             erase(ctx1);
             clear();
             // makeCrosshair();
             drawObjects(ctx1,objects);
             initialT0(p);
             followT0(p);
             initialN0(p);
             followN0(p);
             interstim0(p)
             initialT1(p);
             followT1(p);
             initialN1(p);
             followN1(p);
             Resp(p);

        }


        function initialT0(p){
            // Initial
            setTimeout(function(){
                // Draw stimuli
                erase(ctx1);
                clear();

                c = makeIm('#itemR',centerX,centerY,picsiz,picsiz,window['srcitem00'],1, p.oL) // item 1a

                drawImb(ctx1,c); // dramIma
                makeCrosshair();
                drawObjects(ctx1,objects);

                var DT00 = new Date();
                T00 = DT00.getTime();
                realtime.push(T00);
                // console.log(T0);
            },prestim);
        }

        function followT0(p){
            // follow
	        setTimeout(function(){
             // Draw stimuli
	            erase(ctx1);
                clear();
	            c = makeIm('#itemL',centerX,centerY,picsiz,picsiz,window['srcitem01'],1, p.oL) // item 1b
	            
	            drawImb(ctx1,c);
	            makeCrosshair();
	            drawObjects(ctx1,objects);

                var DT0 = new Date();
                T0 = DT0.getTime();
                realtime.push(T0);
                // console.log(T0);
            },prestim+stimdur);
        }

        function initialN0(p){
            // follow
            setTimeout(function(){
                // Draw stimuli
                erase(ctx1);
                clear();
                 c = makeIm('#itemL',centerX-LRpos,centerY,picsiz,picsiz,window['srcitem' + 20],1, p.noL) // noise 1a
                 
                 drawImb(ctx1,c); // dramIma
                makeCrosshair();
                drawObjects(ctx1,objects);
                 

                 clear();
                 makeCrosshair();
                 

                var DT1 = new Date();
                T1 = DT1.getTime();
                realtime.push(T1);
                // console.log(T0);
            },prestim+stimdur+stimdur);
        }

        function followN0(p){
            // follow
            setTimeout(function(){
                // Draw stimuli
                erase(ctx1);
                clear();
                c = makeIm('#itemL',centerX-LRpos,centerY,picsiz,picsiz,window['srcitem' + 21],1, p.noL) // noise 1b
               
               drawImb(ctx1,c); // dramIma
                makeCrosshair();
                drawObjects(ctx1,objects);
                 
                var DT2 = new Date();
                T2 = DT2.getTime();
                realtime.push(T2);
                // console.log(T0);
            },prestim+stimdur+stimdur+noisedur);
        }

        function interstim0(p){
            // follow
            setTimeout(function(){
                // Draw stimuli
                erase(ctx1);
                clear();
                makeCrosshair();
                drawObjects(ctx1,objects);

                var DT3 = new Date();
                T3 = DT3.getTime();
                realtime.push(T3);
                // console.log(T0);
            },prestim+stimdur+stimdur+noisedur+noisedur);
        }

        // second target starts here
        function initialT1(p){
            // Initial
            setTimeout(function(){
                // Draw stimuli
                erase(ctx1);
                clear();
                 c = makeIm('#itemR',centerX+10,centerY,picsiz,picsiz,window['srcitem00'],1, p.oR) // item 1a
                drawImb(ctx1,c); // dramIma
                makeCrosshair();
                drawObjects(ctx1,objects);

                var DT00 = new Date();
                T00 = DT00.getTime();
                realtime.push(T00);
                // console.log(T0);
            },prestim+stimdur+stimdur+noisedur+noisedur+interstim);
        }

        function followT1(p){
            // follow
            setTimeout(function(){
                // Draw stimuli
                erase(ctx1);
                clear();
                 c = makeIm('#itemL',centerX,centerY,picsiz,picsiz,window['srcitem01'],1, p.oR) // item 1b
              drawImb(ctx1,c); // dramIma
                makeCrosshair();
                drawObjects(ctx1,objects);

                var DT0 = new Date();
                T0 = DT0.getTime();
                realtime.push(T0);
                // console.log(T0);
            },prestim+stimdur+stimdur+noisedur+noisedur+interstim+stimdur);
        }

        function initialN1(p){
            // follow
            setTimeout(function(){
                // Draw stimuli
                erase(ctx1);
                clear();
                 c = makeIm('#itemL',centerX-LRpos,centerY,picsiz,picsiz,window['srcitem' + 20],1, p.noR) // noise 1a
                drawImb(ctx1,c); // dramIma
                makeCrosshair();
                drawObjects(ctx1,objects);

                var DT1 = new Date();
                T1 = DT1.getTime();
                realtime.push(T1);
                // console.log(T0);
            },prestim+stimdur+stimdur+noisedur+noisedur+interstim+stimdur+stimdur);
        }

        function followN1(p){
            // follow
            setTimeout(function(){
                // Draw stimuli
                erase(ctx1);
                clear();
                 c = makeIm('#itemL',centerX-LRpos,centerY,picsiz,picsiz,window['srcitem' + 21],1, p.noR) // noise 1b
                drawImb(ctx1,c); // dramIma
                makeCrosshair();
                drawObjects(ctx1,objects);

                var DT2 = new Date();
                T2 = DT2.getTime();
                realtime.push(T2);
                // console.log(T0);
            },prestim+stimdur+stimdur+noisedur+noisedur+interstim+stimdur+stimdur+noisedur2);
        }

        function Resp(p){
          setTimeout(function(){
            startTime()
            var DT5 = new Date();
            T5 = DT5.getTime();
            realtime.push(T5);
            erase(ctx1);
            clear();
            makeCrosshairWhite();
            drawObjects(ctx1,objects);

            $('#leftright').show();
            if (isTestKey){
              $(document).on("keypress.trialWait", function PressedKey(evt) {
                evt.preventDefault() 
                isTestKey = false;
                if (evt.which == CCWKey | evt.which == CWKey) {
                  rt.push(endTime());
                  $('#leftright').hide();

                  if (evt.which == CCWKey){
                      respCW = 0;
                  }
                  if (evt.which == CWKey){
                      respCW = 1;
                  } 
                  respCWs.push(respCW);
                  trialIsOver();
                }
              })
          }
          },prestim+stimdur+stimdur+noisedur+noisedur+interstim+stimdur+stimdur+noisedur2+noisedur2);
        }

        function showFirstTrial() {
            is_practice = false;
            $(document).off("keypress.trialWait");
            // Draw first fixation 
            $('#frame4').hide();
            makeCrosshair();
            drawObjects(ctx1,objects);
            // Begin
            showTrial(0);
            startTrialTime = new Date();
            $('.trialDiv').hide();
        }

        function showPractice_f1(){
            
            if ($(window).width() >= 600 && screen.width*.8 < $(window).width()) { // && screen.width*.8 < $(window).width())
                $('#instructions').hide();
                // $('#lookDown').show();

                makeCrosshair();
                drawObjects(ctx1,objects);

                $('#frame1').show();
                // Begin
                $(document).on("keypress.trialWait", PressedKey);

                function PressedKey(evt) {
                    if (evt.which == 32) {
                        showPractice_f21();
                    }
                }
            }
        }

        function showPractice_f21(){
        	$(document).off("keypress.trialWait");
            $('#frame1').hide();
            // $('#lookDown').hide();

            erase(ctx1);
            clear();
            p=[];
            p.oL = 10;
            p.oR = 80;
            p.noL = 15;
            p.noR = 5;
            p.targetang = 40;
            p.probeDir = 1;
            p.cueDir = 2;
            realtime = [];
		     initialT0(p);
		     followT0(p);
		     initialN0(p);
         interstim0(p)

		    setTimeout(function(){
            $('#frame21').show();
            $(document).on("keypress.trialWait", PressedKey);
            function PressedKey(evt) { if (evt.which == 32) {showPractice_f22();}}
         },3000)   
        }

        function showPractice_f22(){
            $(document).off("keypress.trialWait");
            $('#frame21').hide();
            erase(ctx1);
            clear();
            c = makeIm('#itemL',centerX,centerY,picsiz,picsiz,srcitem20,1,10)
            drawImb(ctx1,c);
            makeCrosshair();
            drawObjects(ctx1,objects);
            $('#frame22').show();
            $(document).on("keypress.trialWait", PressedKey2);
            function PressedKey2(evt) { if (evt.which == 32) {showPractice_f3();}}
        }


        function showPractice_f3(){
          $(document).off("keypress.trialWait");
          $('#frame22').hide();
          curprobe = '1'
          erase(ctx1);
          clear();
          clear();
          p=[];
          p.oL = 90;
          p.oR = 100;
          p.noL = 90;
          p.noR = 100;
          // p.targetang = 40;
          // p.probeDir = 1;
          // p.cueDir = 2;
          is_practice=true;

          realtime = [];
          isTestKey = true;
          initialT0(p);
          followT0(p);
          initialN0(p);
          followN0(p);
          interstim0(p)
          initialT1(p);
          followT1(p);
          initialN1(p);
          followN1(p);
          Resp(p);


          // makeNumberCue(curprobe);
          drawObjects(ctx1,objects);
          // $('#frame3').show();
          // $(document).on("keypress.trialWait", PressedKey3);
          // function PressedKey3(evt) { if (evt.which == 32) {showPractice_f4();}}
        }

        function showPractice_f4(){
                $(document).off("keypress.trialWait");
                is_practice = false;
                erase(ctx1);
                clear();

                
                $('#frame4').show();
                $(document).on("keypress.trialWait", function press6 (evt) { evt.preventDefault();  if (IsTurkPreview() == false) {showFirstTrial();}});
        }


        function Done() {

            $("#myCanvas").hide();
            $("#done").show();

            var dataToServer = {};
            dataToServer.id = getParameterByName("subjectId"); /* getParameterByName("code") */
            dataToServer.experimenter = 'S_Tim';
            dataToServer.experimentName = 'CD_Task_v1';
            dataToServer.curData = JSON.stringify(trialStruct);
            $.post("https://psyc241.ucsd.edu/Turk/save.php", dataToServer, AfterSuccessDataSaving).fail(AfterFailedSaving);
        }

        function AfterSuccessDataSaving() {
          // After they are done, send them here:
          // window.location = "https://ucsd.sona-systems.com/webstudy_credit.aspx?experiment_id=1267&credit_token=805f6634de5a46b3aecffe2818d8d90c&survey_code=" + getParameterByName("code");
          $('#submitButton').show();
          $('#done').html("All done, thanks! Please click submit button.");
          
          console.log("Saved!");
        }

        function AfterFailedSaving() {
          console.log("oops, failed to save");

          // window.location = "https://ucsd.sona-systems.com/webstudy_credit.aspx?experiment_id=1267&credit_token=805f6634de5a46b3aecffe2818d8d90c&survey_code=" + getParameterByName("code");  
          $('#submitButton').show();
          $('#done').html("All done, thanks! Please click submit button.");

        }

        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        $('#startExperiment').click(showPractice_f1);
        $('.responseButton').click(trialIsOver);

        /**
         * Gets a URL parameter from the query string
         */
        function turkGetParam( name, defaultValue ) { 
           var regexS = "[\?&]"+name+"=([^&#]*)"; 
           var regex = new RegExp( regexS ); 
           var tmpURL = window.location.href; 
           var results = regex.exec( tmpURL ); 
           if( results == null ) { 
             return defaultValue; 
           } else { 
             return results[1];    
           } 
        }

        function GetWorkerId() {
            var workerId = turkGetParam( 'workerId', 'NONE' );
            return workerId;
        }   

        function IsTurkPreview() {
            return GetWorkerId() == "NONE";
        }   

        function IsOnTurk() {
          try {
            return ((window.location.host.indexOf('mturk')!=-1) || document.forms["mturk_form"] ||
              (top != self && window.parent.location.host.indexOf("mturk") != -1));
          } catch(err) {
            // insecure content trying to access https://turk probably, so say yes:
            return true;
          }
        }

        $('#startExperiment').click(showPractice_f1);
        $('.responseButton').click(trialIsOver);
    </script><!-- do not put this on Turk --><!-- <input type="submit" id="submitButton">